<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pet-Portre Canlı Destek</title>

  <!-- ✅ Full favicon setup -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="mask-icon" href="/favicon.svg" color="#4a90e2">
  <link rel="apple-touch-icon" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.svg">

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { display: none; background: #ffffff; font-family: 'Arial', sans-serif; height: 100vh; overflow: hidden; }
    .wrapper { display: flex; width: 100%; height: 100%; }
    .side-panel { flex: 1.2; background-size: cover; background-position: center; }
    .left-panel { background-image: url('https://i.imgur.com/9PpOW4r.jpeg'); }
    .right-panel { background-image: url('https://i.imgur.com/YHBQc9r.jpeg'); }
    .center-panel { flex: 1.6; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    .quote { font-family: 'Playfair Display', serif; font-style: italic; font-size: 14px; color: #444; text-align: center; margin-bottom: 16px; max-width: 90%; }
    .chat-box { width: 360px; max-height: 560px; background-color: #f9f9f9; border-radius: 12px; box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; }
    .chat-header { background-color: #4a90e2; color: white; padding: 12px 16px; font-weight: bold; display: flex; align-items: center; justify-content: space-between; }
    .chat-header-left { display: flex; align-items: center; gap: 10px; }
    .chat-header img.agent { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; }
    .chat-header img.logo { height: 46px; margin-right: 4px; }
    .chat-body { padding: 10px; height: 320px; overflow-y: auto; font-size: 16px; }
    .chat-footer { padding: 10px; display: flex; gap: 6px; border-top: 1px solid #ccc; }
    .offline-message { padding: 10px; text-align: center; color: #444; font-size: 14px; border-top: 1px solid #ccc; background-color: #f1f1f1; width: 100%; }
    .chat-footer input { flex: 1; padding: 8px 12px; border-radius: 20px; border: 1px solid #ccc; font-size: 16px; }
    .chat-footer button { background-color: #4a90e2; color: white; border: none; border-radius: 20px; padding: 8px 14px; cursor: pointer; }
    .typing-indicator { font-style: italic; color: grey; margin-top: 5px; }
    .home-link { margin-bottom: 20px; font-size: 19px; color: #4a90e2; text-decoration: none; border: 2px solid #4a90e2; padding: 10px 22px; border-radius: 30px; transition: background 0.3s, color 0.3s; }
    .home-link:hover { background-color: #4a90e2; color: white; }
    .customer-message { color: #4a90e2; }
    @media (max-width: 900px) {
      .left-panel, .right-panel { display: none; }
      .center-panel { flex: 1; justify-content: flex-start; padding: 12px; }
      .quote { margin-top: 12px; font-size: 16px; }
      .home-link { margin-top: 6px; margin-bottom: 16px; padding: 12px 26px; font-size: 18px; }
      .chat-box { width: 100%; border-radius: 16px; font-size: 17px; flex-shrink: 0; display: flex; flex-direction: column; height: auto; max-height: 100%; }
      .chat-header { padding: 16px; flex-shrink: 0; }
      .chat-header img.agent { width: 46px; height: 46px; }
      .chat-header img.logo { height: 54px; }
      .chat-body { font-size: 17px; padding: 14px; overflow-y: auto; flex-grow: 1; }
      .chat-footer { padding: 14px; gap: 8px; flex-shrink: 0; border-top: 1px solid #ccc; }
      .chat-footer input { font-size: 17px; padding: 12px 16px; }
      .chat-footer button { padding: 12px 16px; font-size: 17px; }
      .typing-indicator { font-size: 15px; margin-top: 8px; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="side-panel left-panel"></div>
    <div class="center-panel">
      <img src="https://i.imgur.com/vEWFUq1.png" alt="Pet-Portre Logo" style="height: 120px; margin-bottom: 12px;" />
      <div class="quote">Her hayvan, kalbinizde bir pati izi bırakır.</div>
      <a class="home-link" href="https://www.pet-portre.com" target="_blank" rel="noopener noreferrer">Ana Sayfaya Dön</a>

      <div class="chat-box" id="chatContainer" style="display: none;">
        <div class="chat-header">
          <div class="chat-header-left">
            <img class="agent" id="agentImage" src="" alt="Agent" />
            <span><span id="agentName"></span> – Canlı Destek</span>
          </div>
          <img class="logo" src="https://i.imgur.com/up4h6Nl.png" alt="Pet-Portre Logo" />
        </div>
        <div class="chat-body" id="chatBody">
          <div id="chatMessages"></div>
          <div class="typing-indicator" id="typingIndicator" style="display:none;"></div>
        </div>
        <div class="chat-footer" id="chatFooter">
          <input type="text" id="chatInput" placeholder="Mesajınızı yazın..." onkeypress="handleKeyPress(event)" />
          <button onclick="sendMessage()">Gönder</button>
        </div>
      </div>
    </div>
    <div class="side-panel right-panel"></div>
  </div>

<script>
if (window.self === window.top) {
  const backendURL = "https://pet-portre-chat-backend.vercel.app";
  const SIX_HOURS = 21600000;

  function getSessionId() {
    const storedId = localStorage.getItem("chatSessionId");
    if (storedId) return storedId;
    const newId = Math.random().toString(36).substring(7);
    localStorage.setItem("chatSessionId", newId);
    return newId;
  }

  function saveChatState(agent, messagesHTML) {
    localStorage.setItem("chatState", JSON.stringify({
      agent,
      messages: messagesHTML,
      timestamp: Date.now()
    }));
  }

  function scrollToBottom() {
    const chatBody = document.getElementById("chatBody");
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  window.handleKeyPress = function (event) {
    if (event.key === "Enter") sendMessage();
  };

  function sendMessage() {
    const input = document.getElementById("chatInput");
    const message = input.value.trim();
    if (message === "") return;

    const messagesEl = document.getElementById("chatMessages");
    messagesEl.innerHTML += `<div><strong class="customer-message">Siz:</strong> <span class="customer-message">${message}</span></div>`;
    input.value = "";
    scrollToBottom();

    const sessionId = getSessionId();
    const typing = document.getElementById("typingIndicator");
    typing.style.display = "none";

    fetch(`${backendURL}/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId, message })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("agentImage").src = data.agent.img;
      document.getElementById("agentName").innerText = data.agent.name;

      if (data.isOpen === false) {
        document.getElementById("chatFooter").innerHTML = `<div class="offline-message">${data.message.replace(/\n/g, "<br>")}</div>`;
        saveChatState(data.agent, messagesEl.innerHTML);
        typing.style.display = "none";
        return;
      }

      setTimeout(() => {
        typing.innerText = data.agent.name + " yazıyor...";
        typing.style.display = "block";
        scrollToBottom();

        setTimeout(() => {
          typing.style.display = "none";
          messagesEl.innerHTML += `<div><strong>${data.agent.name}:</strong> ${data.message}</div>`;
          scrollToBottom();
          saveChatState(data.agent, messagesEl.innerHTML);
        }, data.delay.typingTime);
      }, data.delay.beforeTyping);
    })
    .catch(err => {
      console.error("Chat backend error:", err);
      typing.style.display = "none";
      messagesEl.innerHTML += `<div><strong>Sistem:</strong> Şu anda yanıt verilemiyor.</div>`;
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    document.body.style.display = "block";
    document.getElementById("chatContainer").style.display = "flex";

    const stored = JSON.parse(localStorage.getItem("chatState"));
    if (stored && Date.now() - stored.timestamp < SIX_HOURS) {
      document.getElementById("agentImage").src = stored.agent.img;
      document.getElementById("agentName").innerText = stored.agent.name;
      document.getElementById("chatMessages").innerHTML = stored.messages;
      scrollToBottom();
      return; // Skip init, we already have memory
    }

    const sessionId = getSessionId();
    fetch(`${backendURL}/init`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sessionId })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("agentImage").src = data.agent.img;
      document.getElementById("agentName").innerText = data.agent.name;

      if (data.isOpen === false) {
        document.getElementById("chatFooter").innerHTML = `<div class="offline-message">${data.greeting.replace(/\n/g, "<br>")}</div>`;
        saveChatState(data.agent, "");
        return;
      }

      const messagesEl = document.getElementById("chatMessages");
      messagesEl.innerHTML = `<div><strong>${data.agent.name}:</strong> ${data.greeting}</div>`;
      scrollToBottom();
      saveChatState(data.agent, messagesEl.innerHTML);
    })
    .catch(err => console.error("Init error:", err));
  });
}
</script>
</body>
</html>

